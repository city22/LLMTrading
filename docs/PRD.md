# LLMTrading 产品需求文档（PRD）

## 1. 背景与目标
- **目标**：构建一个多 AI Agent 协同的高频数字货币交易系统，接入 OKX 交易所，支持实时交易监控、透明的决策过程呈现，以及可视化的 Prompt 管理与即时生效。
- **核心价值**：
  - 利用 DeepSeek 等大模型的多角色协同，提升交易决策的速度与质量。
  - 提供可审计的决策链路，满足风险合规与策略优化需求。
  - 通过前后端联动，实现实时的交易与资金监控体验。

## 2. 用户与场景
- **用户角色**
  - 量化研究员：配置与迭代多 Agent Prompt，观测决策链路与回测/实盘表现。
  - 交易员/风控人员：实时监控资金、订单、策略执行；可手动干预或紧急止损。
  - 技术运维：部署、运维与监控系统健康与日志。
- **应用场景**
  - 高频/中频现货或合约交易（OKX 接口）。
  - 策略演进：调整 Prompt，快速上线新策略或风控规则。
  - 透明审计：复盘每笔交易的决策链路与 Agent 贡献。

## 3. 功能范围
### 3.1 后端（Python Service）
- OKX 账户与交易管理：下单、撤单、查询持仓/余额、费率获取。
- 市场数据接入：订阅/拉取盘口、K 线、成交、资金费率、订单簿深度。
- 多 Agent 管理：宏观交易员、新闻搜集员、数据分析员、技术指标分析员、订单流分析员、交易决策员、风险控制员等。
- Prompt 配置与热更新：存储、编辑、即时生效，支持版本记录与回滚。
- 决策链路记录：Agent 输入/输出、模型参数、引用数据快照、时间戳。
- 交易执行流水：信号生成、风控校验、下单、回执、成交/撤单状态追踪。
- 风控：风控参数（最大仓位、单笔最大亏损、风控白名单/黑名单、熔断规则）、紧急平仓、人工干预接口。
- 通知与告警：异常滑点、成交异常、API 错误、风控触发、模型异常。

### 3.2 前端（Vue.js）
- **实时交易监控页**
  - 总资产、可用余额、持仓、浮动盈亏、累计收益曲线。
  - 实时订单流水（委托、成交、撤单）、策略信号、风险状态提示。
  - 参考 nof1.ai 样式：深色主题、卡片化指标、可切换时间区间。
- **透明决策链路页（News Feed 样式）**
  - 时间轴/Feed 卡片展示：每个 Agent 的输入、输出、使用的市场数据、调用的模型版本、信号/建议。
  - 支持过滤（按 Agent、币种、时间）与搜索。
  - 关联交易：点击决策卡片可查看对应下单/成交记录。
- **Prompt 编辑页**
  - Agent 列表与搜索；点击进入编辑器（支持 YAML/JSON 格式存储）。
  - 支持 Prompt 分段（背景、目标、约束、输出格式）、参数（温度、max_tokens、top_p）编辑。
  - 保存即生效，提供版本号、版本描述、回滚操作；保存前校验格式。
- **系统设置/风控页（可选迭代）**
  - 配置风控阈值、熔断条件、API Key、网络代理、日志等级。

## 4. 业务流程
### 4.1 信号生成与交易执行（实盘）
1. 数据采集：行情/订单簿订阅 → 数据分析员、技术指标分析员、订单流分析员使用。
2. 资讯采集：新闻搜集员抓取新闻/社交数据 → 宏观交易员评估宏观情绪。
3. Agent 协同：
   - 各 Agent 基于自身 Prompt 输出特征/观点。
   - 交易决策员汇总 Agent 输出、行情数据、仓位与风控参数，生成交易指令。
   - 风控校验（风险控制员）：检查仓位限制、滑点、风控规则。
4. 交易执行：下单 → OKX 回执 → 订单状态跟踪（部分成交/完全成交/撤单）。
5. 记录链路：保存所有 Agent 输入/输出、行情快照、下单参数、回执、风控结果。
6. 前端展示：实时监控页更新资产/订单；决策链路页新增 Feed 卡片。

### 4.2 Prompt 编辑与生效
1. 在 Prompt 编辑页选择 Agent → 进入编辑器。
2. 用户编辑 Prompt/参数 → 前端校验 → 保存。
3. 后端保存版本记录并热更新对应 Agent；返回新版本号。
4. 更新成功后，后端在下一次 Agent 调用时使用最新 Prompt。
5. 前端在决策 Feed 中标记使用的 Prompt 版本，便于审计。

### 4.3 风控与告警
- 触发条件：超仓、滑点超阈值、API 失败次数、订单拒绝、延迟超限、策略异常输出。
- 响应：暂停策略、撤单、平仓、发送告警（邮件/IM/前端弹窗），记录事件。

## 5. 功能需求细项
### 5.1 后端接口（示例）
- `/api/health`：健康检查。
- `/api/portfolio/summary`：资产、持仓汇总。
- `/api/orders/stream`：实时订单/成交推送（WebSocket）。
- `/api/agents/feed`：决策链路 feed（分页/过滤）。
- `/api/prompts`：列表/获取/创建/更新/回滚 Prompt。
- `/api/trade/signal`：策略信号（内部调用）。
- `/api/risk/actions`：暂停/恢复策略、紧急平仓。

### 5.2 数据模型要点
- AgentConfig：`id/name/role/prompt/params/version/updated_by/updated_at`。
- DecisionRecord：包含 `agent_id`、输入、输出、引用行情快照、使用的 Prompt 版本、时间戳、关联订单 ID。
- Order/Trade：订单信息、成交信息、状态、手续费、滑点、对手价、风险标签。
- RiskRule：阈值、启用状态、触发记录。

### 5.3 非功能需求
- 性能：实时推送延迟 < 1s；行情/订单处理 QPS 满足高频需求（根据订阅范围扩展）。
- 可用性：核心服务支持自动重启；关键接口具备重试/降级机制。
- 安全：API Key 加密存储；权限控制（编辑 Prompt、执行风控、查看资产）。
- 可观测性：日志分级、分布式追踪 ID、指标（订单延迟、滑点、模型耗时）。

## 6. UI 设计（概要）
### 6.1 设计风格
- 深色主题、卡片化布局，参考 nof1.ai 风格；使用主色 #0F172A / 辅色 #22D3EE。
- 统一组件：顶部导航（Logo、环境切换、用户信息）、侧边菜单、主内容区。

### 6.2 页面结构
1. **实时交易监控页**
   - 顶部：总资产、可用余额、PNL（当日/累计）、仓位杠杆、风险状态。
   - 中部：收益曲线 + 成交量柱状图；盘口/深度与订单流热力图（可选）。
   - 下部：实时订单流水表（状态/方向/价格/数量/成交/滑点/策略 ID）、信号列表、告警通知。
   - 右侧：持仓卡片（币对、数量、均价、浮盈亏、预估爆仓价）。
2. **透明决策链路页（Feed）**
   - 时间线/列表：每条卡片含时间、Agent 角色、输入摘要、输出结论、使用模型与 Prompt 版本、引用数据快照。
   - 支持展开查看完整 Prompt/参数与原始输出；支持按 Agent、币种、时间过滤。
   - 关联订单：卡片内显示关联的订单 ID 与状态，跳转到订单详情。
3. **Prompt 编辑页**
   - 左侧：Agent 列表与搜索；支持标签（宏观/技术/风控）。
   - 右侧：编辑区（分栏：背景/约束/输出格式），模型参数表单（温度、max_tokens、top_p 等）。
   - 底部：版本信息、保存/回滚按钮；保存前高亮语法与校验结果。
4. **系统设置/风控页（可选）**
   - 风控阈值、熔断条件、API Key 配置、代理设置、日志等级，支持测试连接。

### 6.3 交互要点
- 实时刷新：监控与 Feed 页面使用 WebSocket/SSE；提供手动刷新与自动暂停。
- 状态提示：颜色区分买卖方向、风险状态、告警类型；支持桌面/邮件通知配置。
- 操作反馈：保存 Prompt 提供 Loading、成功/失败 Toast；版本回滚需确认弹窗。

## 7. 技术架构
### 7.1 总体架构
- 前端：Vue.js + Vite，组件库（Element Plus/TDesign/Naive UI 任选其一），ECharts/Plotly 用于图表。
- 后端：Python FastAPI/Flask（推荐 FastAPI）；异步任务与流式处理使用 asyncio/uvloop。
- Agent 编排：
  - DeepSeek API 调用封装，支持多模型版本与参数控制。
  - Agent 管理器：注册/加载 Prompt，执行链路记录，热更新。
  - 任务队列：处理行情/新闻数据、特征计算、模型调用（可用 Celery/Redis 或 asyncio 队列）。
- 数据层：
  - 时序/行情缓存：Redis/TimescaleDB；
  - 配置与版本：PostgreSQL（Prompt、版本、风控规则、订单日志）；
  - 日志与追踪：Elastic/ClickHouse（可选）。
- 交易所接入：OKX REST/WebSocket（行情 + 交易），含签名、限频与重连机制。
- 推送：WebSocket/SSE 推送监控数据与决策 Feed。
- 部署：Docker Compose/K8s；分环境（dev/stage/prod）。

### 7.2 模块分解
- `ingestion`：行情/新闻采集，订单簿/成交订阅。
- `feature`：特征计算、技术指标、订单流分析。
- `agents`：各角色 Agent 执行、Prompt 管理、调用 DeepSeek。
- `risk`：风控规则引擎，限仓/熔断/滑点控制，人工干预。
- `executor`：信号接收、交易指令生成、OKX 下单与跟踪。
- `api`：FastAPI 提供 REST/WebSocket 服务，鉴权与权限控制。
- `persistence`：数据库与缓存访问层，版本记录与审计。
- `monitoring`：日志/指标/告警。

### 7.3 数据流与时序（简述）
1. 行情/新闻 → `ingestion` → `feature` → Agent 输入；
2. Agent 输出 → `agents` 汇总 → `risk` 校验 → `executor` 下单；
3. 下单回执/成交 → `persistence` 存储 → `api` 推送 → 前端监控/Feed；
4. Prompt 更新 → `agents` 热更新 → 新版本号记录 → 决策 Feed 展示。

## 8. 交付物与里程碑
- M1：基础后端骨架（API、行情订阅、OKX 下单沙箱）、基础前端框架与实时监控页雏形。
- M2：多 Agent 调用链路、决策 Feed、Prompt 编辑与版本管理、风控规则初版。
- M3：性能与可靠性优化、告警与可观测性、前端样式完善、部署与文档。

## 9. 测试计划
### 9.1 测试范围
- 后端 API、Agent 编排、风控、交易执行、数据持久化、实时推送。
- 前端页面渲染、交互、实时刷新、状态提示、编辑与回滚。
- 安全与权限、异常与告警、性能与压力测试。

### 9.2 示例测试用例
- **API**：健康检查、资产/持仓查询、订单创建与状态流转、WebSocket 推送订阅/断线重连。
- **Agent**：Prompt 版本更新后调用是否生效；多 Agent 输出合并逻辑；异常输出处理（空输出、延迟、模型错误）。
- **风控**：超仓/滑点阈值触发暂停；熔断后恢复；紧急平仓流程；人工干预接口权限。
- **交易执行**：信号 → 风控 → 下单 → 回执/成交/撤单；部分成交、拒单、网络异常重试。
- **前端**：
  - 监控页：资产/PNL/订单表实时更新，图表正确渲染；
  - 决策 Feed：过滤/搜索、卡片展开、关联订单跳转；
  - Prompt 编辑：语法校验、保存成功/失败提示、版本回滚；
  - 权限：不同角色的访问控制。
- **性能/稳定性**：高频行情推送下的延迟与 CPU/内存占用；WebSocket 大量订阅稳定性。

### 9.3 测试方式
- 单元测试：Agent 调用、特征计算、风控校验、API 控制器。
- 集成测试：OKX 沙箱对接、行情 → 信号 → 风控 → 下单链路；WebSocket 推送。
- 前端测试：组件单元测试（Vue Test Utils）、端到端测试（Playwright/Cypress）。
- 性能测试：k6/Locust 对 WebSocket 与 REST 进行压测；行情模拟器产生日志。
- 回归与验收：按照 M1/M2/M3 里程碑的功能清单执行。

## 10. 风险与依赖
- 外部依赖：OKX 接口稳定性与限频；新闻/社交数据源可用性；DeepSeek API 配额。
- 模型风险：大模型幻觉、延迟、稳定性；需设置超时与降级策略。
- 交易风险：极端行情导致滑点/拒单；需冗余风控与熔断。
- 法规与合规：交易所及所在地区监管要求。

## 11. 监控与告警指标（建议）
- 交易：下单成功率、平均延迟、滑点分布、成交率、拒单率。
- Agent：调用成功率、耗时分布、Token 消耗、异常输出数量。
- 系统：WebSocket 断连次数、重连成功率、API 错误率、队列堆积、CPU/内存、磁盘/网络 IO。
- 资金与风险：仓位利用率、最大回撤、风险阈值触发次数、熔断事件。

## 12. 文档与运维
- 配置说明：OKX Key/Secret/Passphrase 配置、网络代理、数据库与缓存配置、模型 Key。
- 启动说明：本地/容器化启动步骤；开发/生产配置差异。
- 日志与审计：决策链路日志、风控事件、订单流水、Prompt 版本变更记录。
- 灰度与回滚：Prompt 回滚、策略灰度、服务回滚与多环境发布策略。
